---
title: "Análise COVID19 em Portugal"
author: "Raquel Costa"
date: "23/09/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introdução

Este documento é uma análise sobre COVID19 em Portugal com base nos dados da DGS disponíveis em <https://github.com/dssg-pt/covid19pt-data>. Uma vez que importamos os dados diretamente da internet, estes dados vão sendo atualidados diariamente bem como a sua análise.



```{r echo=FALSE, warning=FALSE, error=FALSE}

#Importar libraries
library(data.table)
library(ggplot2)
library(grid)
library(dplyr)
library(tibble)
library(reshape2)
library(ggpubr)
library(maps)
library(ggiraph)
library(leaflet)
library(geojsonio)
library(gganimate)
library(plotly)
library(RColorBrewer)

#Importar dados
data <- fread("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/data.csv")

#Data de chr para Date
data$data <- as.Date(data$data,"%d-%m-%Y")

#Mapa de Portugal
mapa_pt <- geojson_read("https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/extra/mapas/portugal.geojson",
                        what = "sp")
```

## Análise dos Sintomas

Na base de dados existem colunas, uma para cada sintoma, que apresenta a percentagem de pessoas com esse sintoma, nesse dia. O comportamento dos dados leva-nos a crer que estes valores sejam cumulativos.

Estes dados só foram registados de dia 03/03/2020 até dia 16/08/2020 e, para além disso, tal como é referido na base de dados online, estes dados são relativos apenas a uma percentagem, não-especificada e variável, dos infetados. Por este motivo, apesar de termos realizado duas análises simples, estes resultados podem não ser fiáveis nem representativos da realidade.

### Frequência dos Sintomas

A primeira análise realizada é a frequência mais atual de cada sintoma nos pacientes com COVID19. Com este gráfico podemos ver que o sintoma mais frequente é a tosse com 34%  dos infetados a apresentarem esse sintoma, seguindo-se a febre com 27% e a cefaleia e dores musculares ambos com 20%.

```{r pressure, echo=TRUE, warning=FALSE}

#Criar uma tabela com uma coluna para os sintomas, dar-lhe o nome "sintoma", mudar o nome de cada sintoma na tabela e criar outra coluna para os últimos valores registados de cada sintoma e dar-lhe o nome "percentagem"
sintomas <- as.data.frame(t(data[173,41:46])) %>% 
  rownames_to_column(var = "sintoma")
names(sintomas)[2] = "frequencia"
sintomas[, 1] = c("Tosse", "Febre", "Dificuldade Respiratória", "Cefaleia", "Dores Musculares", "Fraqueza Generalizada")

#Fazer um gráfico de barras com os sintomas no eixo do x e a percentagem no eixo dos y
ggplot(sintomas, aes(x = sintoma, y = frequencia*100)) +
  geom_col(fill = "slategray3",  width = 0.7) +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(sintomas$frequencia*100 + 10))) +
  theme_classic() +
  labs(title = "Frequência de Sintomas nos Pacientes com COVID19") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 20, 
                                  color = "black", hjust = 0.5)) +
  xlab("Sintomas") +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("Frequência (%)") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = scales::percent(frequencia, digits = 2)), vjust = -0.5, size = 4) +
  scale_x_discrete(labels = c("Cefaleia", "Dificuldade\nRespiratória", "Dores\nMusculares",
                              "Febre", "Fraqueza\nGeneralizada", "Tosse"))

```

### Frequência dos Sintomas ao Longo do Tempo

De seguida analisámos a evolução desses mesmos sintomas ao longo do tempo, com base em frequências diárias para cada sintoma. Com a análise destes gráficos podemos perceber a grande oscilação dos sintomas ao longo do tempo.

```{r echo= TRUE}

#Criar uma tabela com colunas, uma para cada sintoma, sendo o valor para cada dia a frequência desse sintoma nesse dia vezes o número de confirmados até esse dia menos a frequência desse sintoma no dia anterior vezes o número de confirmados até ao dia anterior, isto para nos dar o número de pessoas com esse sintoma nesse dia apenas, e depois tudo a dividir pelo número de novos confirmados nesse dia para termos o resultado em percentagem. 
sintomas_tempo <- as.data.frame((data[8:173,41:46]*data$confirmados[8:173])
                                -(data[7:172, 41:46]*data$confirmados[7:172]))/data$confirmados_novos[8:173] 

#Acresecentar à tabela que criámos, uma coluna com as datas
sintomas_tempo <- rbind(data[7, 41:46], sintomas_tempo)

#É ainda necessário acrescentar a linha 7 pois como são as primerias frequências a aparecer já indicam a frequência específica para esse dia
sintomas_tempo <- cbind(data$data[7:173], sintomas_tempo)

#No casos do sintoma Dificuldade Respiratória, este só começou a ser registado mais tarde pelo que o primerio valor que já representa a frequência específica para esse dia é o da linha 3, coluna 4
sintomas_tempo[3, 4] <- 0.11

#Mudar os nomes das colunas
names(sintomas_tempo) <- c("Data", "Tosse", "Febre", "Dificuldade respiratória", "Cefaleia", "Dores Musculares",  "Fraqueza Generalizada")

#Fazer o melt da tablea para poder representar a ecolução temporal num gráfico e mudar o nome da coluna 2 para Sintomas
sintomas_tempo_melt <-  melt(sintomas_tempo, id.vars="Data")
names(sintomas_tempo_melt)[2] <- "sintoma"

#Fazer um gráfico de linhas com a data no eixo do x, a frequência diária dos sintomas no eixo dos y e cada sintoma numa linha
ggplot(sintomas_tempo_melt, aes(x = Data, y = value*100, color = sintoma)) +
  geom_line() +
  facet_grid(sintomas_tempo_melt$sintoma) +
  guides(color = FALSE) +
  xlab("Mês") +
  ylab("Frequência (%)")+
  labs(title = "Frequência de Sintomas ao Longo do Tempo") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15))
```

## Análise dos Casos

### Casos por Grupo Etário e Género

Primeiro vamos avaliar o número de casos de COVID19 por grupo etário e dentro de cada grupo etário por género e total.

Com este gráfico, à data da análise (Setembro 2020) podemos ver que a população com mais casos de COVID19 é a dos 20 aos 59 anos principalmente, no entanto temos de ter em conta que este gráfico não considera a quantidade de portugueses que existe em cada faixa etária. Podemos ver também que as mulheres aparecem sempre com mais casos que os homens com exceção da faixa etária dos 0 aos 9 anos mas mais uma vez temos de ter em conta que a população portuguesa tem mais mulheres que homens e essse fator nãoe stá aqui a ser ponderado.

```{r}
#Selecionar as colunas de confirmados feminino para todas as idades e juntá-las numa tabela e fazer o mesmo para o masculino
femininos <- as.data.frame(data %>% 
                             dplyr::select(starts_with("confirmados_") & (ends_with("9_f")| ends_with("plus_f"))))

masculinos <- as.data.frame(data %>% 
                              dplyr::select((starts_with("confirmados_") & (ends_with("9_m")| ends_with("plus_m")))))

#Selecionar o valor mais recente de cada coluna de modo a ficar com o número de casos até ao momento para cada faixa etária e para cada género
casos_femininos_idade <- as.data.frame(lapply(femininos, last))
casos_masculinos_idade <- as.data.frame(lapply(masculinos, last))

#Somar a tabela dos femininos com a dos masculinos o que vai dar o número de casos até ao momento por idade apenas
casos_total_idade <- as.data.frame(casos_femininos_idade + casos_masculinos_idade)

#Criar tabela com uma colunda para a faixa etária e outra para o número de casos femininos e mudar coluna da faixa etária para os nomes adequados
casos_femininos_idade_invertido <- as.data.frame(t(casos_femininos_idade)) %>% 
  rownames_to_column(var = "Idade")
names(casos_femininos_idade_invertido)[2] <- "Femininos"
casos_femininos_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Criar tabela com uma colunda para a faixa etária e outra para o número de casos masculinos e mudar coluna da faixa etária para os nomes adequados
casos_masculinos_idade_invertido <- as.data.frame(t(casos_masculinos_idade)) %>% 
  rownames_to_column(var = "Idade")
names(casos_masculinos_idade_invertido)[2] <- "Masculinos"
casos_masculinos_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Criar tabela com uma colunda para a faixa etária e outra para o número de casos total e mudar coluna da faixa etária para os nomes adequados
casos_total_idade_invertido <- as.data.frame(t(casos_total_idade)) %>% 
  rownames_to_column(var = "Idade")
names(casos_total_idade_invertido)[2] <- "Total"
casos_total_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Juntar as 3 tabelas que criámos
casos_fem_masc <- merge(casos_femininos_idade_invertido, casos_masculinos_idade_invertido, by = "Idade")
casos_fem_masc_tot <- merge(casos_fem_masc, casos_total_idade_invertido, by = "Idade")

#Fazer melt para poder fazer gráfico 
casos_fem_masc_tot_melt <- melt(casos_fem_masc_tot, id.vars = "Idade")

#Fazer gráfico de barras com idade no eixo do x, o número de casos no eixo do y e o género em cada barra
ggplot(casos_fem_masc_tot_melt, aes(x = Idade, y = value, fill = variable)) +
  geom_col(position = "dodge") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, max(casos_fem_masc_tot_melt$value + 1000))) +
  theme_classic() +
  labs(title = "Casos Por Idade e Género") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("Mortes") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  guides(fill=guide_legend(title="Género")) +
  geom_text(aes(label = value), position = position_dodge(width = 0.9), vjust = -0.5, size = 2.5) +
  scale_fill_manual(values = c("coral2", "lightblue", "saddlebrown"))
```

### Casos por Grupo Etário ao longo do tempo

Podemos agora ver a evolução do número de casos ao longo do tempo por faixa etária.

```{r warning=FALSE}
#Pegando nas tabelas que fizémos por género or faixa etária, como os valores na base de dados são cumulativos,  fazemos o valor desse dia menos o valor do dia anterior para obtermos o número de novos casos por dia, por faixa etária por género
femininos_novos <- femininos - lag(femininos)
masculinos_novos <- masculinos - lag(masculinos)

#Criar uma tabela com uma coluna para a data e outras colunas com o número de casos por dia por faixa etária apenas que resultam da soma dos novos casos femininos com os novos casos masculinos
casos_total_tempo <- cbind(data$data, as.data.frame(femininos_novos + masculinos_novos))

#Como  linha 7 que é a primeira em que há registo dos casos já representa o número de casos nesse dia apenas, adicionámos essa linha à tabela e mudámos o nome das colunas
casos_total_tempo[7, 2:10] <- femininos[7,] + masculinos[7,]
names(casos_total_tempo)<- c("Data", "0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Fazer melt para fazer o gráfico
casos_total_tempo_melt <- melt(casos_total_tempo, id.vars = "Data")

#Fazer o gráfico de linhas com a data no eixo do x, o número de casos no eixo do y e a faixa etária em cada linha
ggplot(casos_total_tempo_melt, aes(x = Data, y = value, color = variable)) +
  geom_line() +
  facet_grid(casos_total_tempo_melt$variable) +
  guides(color = FALSE) +
  xlab("Mês") +
  ylab("Casos") +
  labs(title = "Casos de COVID19 por Grupo Etário ao Longo do Tempo") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

### Casos por Região

Podemos avaliar o valor mais recente do número de casos confirmados por região.

À data da análise (Setembro 2020), Lisboa e Vale do Tejo é a região com mais casos, seguindo-se o Norte e o Centro. Mais uma vez temos de ter em conta que estes gráficos não tem em conta a população de cada região.

```{r}
#Criar tabela com uma coluna para a região e outra para o valor mais recente do número de casos confirmados, mudar o nome das colunas e mudar o nome das regiões
casos_regioes <- as.data.frame(t(as.data.frame(lapply(data[,confirmados_arsnorte:confirmados_madeira],
                                                      max, na.rm = TRUE))))%>% 
  rownames_to_column(var = "Regioes")
names(casos_regioes)[2] <- "Casos"
casos_regioes[, 1] <- c("Norte", "Centro", "Lisboa e Vale \ndo Tejo", "Alentejo", "Algarve", "Açores", "Madeira")

#Fazer um gráfico de barras com as regiões no eixo do x e o número de casos no eixo do y
ggplot(casos_regioes, aes(x = Regioes, y = Casos)) +
  geom_col(fill = "salmon1") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(casos_regioes$Casos + 10000))) +
  theme_classic() +
  labs(title = "Número de Casos por Região") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = Casos), vjust = -0.5, size = 4)

#mapa
##Definir intervalos que queremos na legenda
bins =  c(0, 200, 600, 1200, 1400, 10000, Inf)

##Colocar as regiões da tabela pela mesma ordem que a dos poligonos
casos_regioes_ordem <- casos_regioes[c(4, 5, 6, 2, 7, 1, 3),]

##Definir a palete de cores para o mapa
pal <- colorBin("YlOrRd", domain = casos_regioes_ordem[,2], bins = bins)

##Definir legenda que aparece quando se passa o rato pelo mapa
labels <- sprintf(
  "<strong>%s</strong><br/>%g casos",
  casos_regioes_ordem[,1], casos_regioes_ordem[,2]
) %>% lapply(htmltools::HTML)

##Fazer o mapa
leaflet(mapa_pt) %>% 
  addTiles(group = "Normal") %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Claro") %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "Escuro") %>% 
  addLayersControl(
    baseGroups = c("Normal", "Claro", "Escuro"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal(casos_regioes_ordem[,2]), 
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                             padding = "3px 8px"),
                                textsize = "15px",
                                direction = "auto")) %>% 
  addLegend(pal = pal, values = casos_regioes_ordem$Casos, opacity = 0.7, title = "Nº Casos",
            position = "bottomright")
```

### Incidência

A incidência é o número de casos nesse dia a dividir pela população de risco que é a população menos o número de confirmados até ao momento, supondo que estes ou já estão infetados no momento ou já foram infetados e por isso apresentam imunidade, menos o número de óbitos. Para a análise ser mais precisa, deveríamos subtrair ainda o número de mortes até ao momento por outras razões que não o COVID19.

```{r warning=FALSE}
#Variáveis com a população total, feminina e masculina com base no INE
populacao_pt = 10295909
mulheres_pt = 5435932
homens_pt = 4859977

#Cálculo da incidência criando uma tabbela para o total, outra para mulheres e outra para homens
incidencia_total <- as.data.frame(data$confirmados_novos/ (populacao_pt - data$confirmados - data$obitos))
incidencia_homens <- as.data.frame((data$confirmados_m - lag(data$confirmados_m)) 
                                   / (homens_pt - data$confirmados_m - data$obitos_m)) 
incidencia_mulheres <- as.data.frame((data$confirmados_f - lag(data$confirmados_f)) /
                                       (mulheres_pt - data$confirmados_f - data$obitos_f))

#Remover valores negativos devido a erro na base de dados original em que valor cumulativo do número casos homens e mulheres era 0 e não devia
incidencia_homens[174:175,] <- NA
incidencia_mulheres[174:175,] <- NA

#Criar uma tabela com as 3 tabelas anteriores, adicionando uma coluna com a data e mudar os nomes das colunas
incidencia <- data.frame(data$data, incidencia_total, incidencia_mulheres, incidencia_homens)
names(incidencia) <- c("Data", "Total", "Mulheres", "Homens")

#Fazer melt para poder fazer gráfico de linhas
incidencia_melt <- melt(incidencia, id.vars = "Data")
names(incidencia_melt)[2] <- "Genero"

#Fazer gráfico de linhas com data no eixo do x, a incidencia no eixo do y e o género em cada linha
ggplot(incidencia_melt, aes(x = Data, y = value*100, color = Genero)) +
  geom_line() +
  facet_grid(incidencia_melt$Genero) +
  guides(color = FALSE) +
  xlab("Mês") +
  ylab("Incidência (%)") + 
  labs(title = "Incidência Diária por Género") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
  
```

### Incidência por Região ao Longo do Tempo

Depois de termos analisado a inciência por género e total, podemos agora analisar a incidência por região ao longo do tempo.

```{r warning=FALSE}
#Valores da população de cada região com base no INE
acores = 242796
alentejo = 705018
algarve = 438635
centro = 2216927
lisboa = 2854802
madeira = 254254
norte = 3573961

###Criar uma tabela com uma coluna para as regiões e outra para o número de pessoas nessa região
populacao_regioes <- as.data.frame(c(norte, centro, lisboa, alentejo, algarve, acores, madeira), 
                                  c("norte", "centro", "lisboa", "alentejo", "algarve", "açores", "madeira"))

#Fazer com que cada coluna seja uma região e repetir cada número as vezes necessárias para ficar com o número igual ao das colunas da base de dados
populacao_regioes_rep <- as.data.frame(t(populacao_regioes[rep(seq_len(ncol(populacao_regioes)), each = nrow(data))]))

#Calcular a incidência em cada região fazendo os casos novos por região a dividir pela população da região  menos os confirmados da região menos os óbitos da região e dar nomes a cada coluna
incidencia_regioes <- cbind(data$data, (as.data.frame(data[, confirmados_arsnorte:confirmados_madeira] 
                                                      - lag(data[, confirmados_arsnorte:confirmados_madeira]))) 
                            / (populacao_regioes_rep - as.data.frame(data[,confirmados_arsnorte:confirmados_madeira] 
                                                                     - data[,obitos_arsnorte:obitos_madeira])))
names(incidencia_regioes) <- c("Data", "Norte", "Centro", "Lisboa e Vale do Tejo", "Alentejo", "Algarve", "Açores", "Madeira")

#Fazer melt para fazer o gráfico e dar nomes a cada coluna
incidencia_regioes_melt <- melt(incidencia_regioes, id.vars = "Data")
names(incidencia_regioes_melt) <- c("data", "regiao", "valor")

#Fazer o gráfico de linhas com a data no eixo do x, a incidência no eixo do y e a região em cada linha
ggplot(incidencia_regioes_melt, aes(x = data, y = valor*100, color = regiao)) +
  geom_line() + 
  labs(x = "Mês", y = "Incidência (%)", title = "Incidência de COVID19 por Região ao Longo do Tempo") +
  facet_grid(incidencia_regioes_melt$regiao) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  guides(color = FALSE) +
  theme(strip.text.y = element_text(size = 8, colour = "burlywood4", angle = 0)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 20, color = "Black", hjust = 0.5)) +
  scale_x_date(breaks = "months", date_labels = "%B")

```

### Incidência por Região 

Analisámos ainda a incidência mais recente por região.

```{r}
#Definir intervalos para legenda
bins_2 =  c(0, 0.002, 0.004, 0.006, 0.008, 0.01, 0.02, Inf)

#Da tabela anterior com todas as datas, selecionar apenas o valor mais recente e mudar nome coluna e regiões
incidencia_regioes_ordem <- as.data.frame(t(as.data.frame(lapply(incidencia_regioes[,c(5, 6, 7, 3, 8, 2, 4)], last)))) %>% 
  rownames_to_column(var = "Regiao") 
incidencia_regioes_ordem[,1] <- c("Alentejo", "Algarve", "Açores","Centro", "Madeira", "Norte", "Lisboa e Vale do Tejo")

#Definir palete de cores para mapa
pal_2 <- colorBin("YlOrRd", domain = incidencia_regioes_ordem[,2]*100, bins = bins_2)

#Definir legenda quando se passa com o rato por cima
labels_2 <- sprintf(
  "<strong>%s</strong><br/>%g&#x25 Incidência",
  incidencia_regioes_ordem[,1], round(incidencia_regioes_ordem[,2]*100, digits = 4)
) %>% lapply(htmltools::HTML)

#Fazer o mapa
leaflet(mapa_pt) %>% 
  addTiles(group = "Normal") %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Claro") %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "Escuro") %>% 
  addLayersControl(
    baseGroups = c("Normal", "Claro", "Escuro"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal_2(incidencia_regioes_ordem[,2]*100), 
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels_2,
    labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                             padding = "3px 8px"),
                                textsize = "15px",
                                direction = "auto")) %>% 
  addLegend(pal = pal, values = incidencia_regioes_ordem[,2]*100, opacity = 0.7, title = "Incidência",
            position = "bottomright")
```


## Análise das Mortes

### Número de Mortes

Relativamente às mortes, a primeira coisa que podemos fazer é saber qual o número total de mortes até ao momento e como é que essas mortes se dividem por género.

```{r}
#Saber o número total de mortes
last(data$obitos)

#Saber o número de mortes por género
##Criar uma tabela com o valor mais recente, que é também o valor mais alto, do óbitos femininos e masculinos, fazendo uma coluna para o género e outra para o número de óbitos
obitos_genero <- as.data.frame(t(as.data.frame(lapply(data[,obitos_f:obitos_m], max, na.rm = TRUE)))) %>% 
  rownames_to_column(var = "genero")
names(obitos_genero)[2] <- "mortes"

##Fazer um gráfico de barras com o genero no eixo do x e o número de mortes no eixo do y
ggplot(obitos_genero, aes(x = genero, y = mortes)) +
  geom_col(fill = "darksalmon") + 
  labs(title = "Número de Mortes Por Género", x = "") + 
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(obitos_genero$mortes + 100))) +
  theme_classic() +
  scale_x_discrete(labels = c("Feminino", "Masculino")) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = mortes), vjust = -0.5, size = 4) +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0),
                                  size = 20, color = "Black", hjust = 0.5))
```

### Número de Mortes por Grupo Etário e Género

Avaliámos depois a distribuição do número de mortes pelos diferentes grupos etários, por género.

À data desta análise (Setembro 2020) é possível observar que o maior número de mortes se encontra na faixa etária dos 80+ seguida pela feixa etária dos 70 aos 79 anos sendo que as faixas etáras que apresentavam maior número de casos de COVID19 não são as que apresentam maior número de óbitos. Isto leva-nos a crer que a população mais velha é aquela que tem maior probabilidade de morrer ao ficar infetada.

```{r}
#Selecionar as colunas de obitos feminino para todas as idades e juntá-las numa tabela e fazer o mesmo para o masculino
femininos_mortes <- as.data.frame(data %>% 
                                    dplyr::select(starts_with("obitos_") & (ends_with("9_f")| ends_with("plus_f"))))

masculinos_mortes <- as.data.frame(data %>% 
                                     dplyr::select((starts_with("obitos_") & (ends_with("9_m")| ends_with("plus_m")))))

#Selecionar o valor mais recente de cada coluna de modo a ficar com o número de óbitos até ao momento  para cada faixa etária e para cada género
mortes_femininos_idade <- as.data.frame(lapply(femininos_mortes, last))
mortes_masculinos_idade <- as.data.frame(lapply(masculinos_mortes, last))

#Somar a tabela dos femininos com a dos masculinos o que vai dar o número de óbitos até ao momento por idade apenas
mortes_total_idade <- as.data.frame(mortes_femininos_idade + mortes_masculinos_idade)

#Criar tabela com uma colunda para a faixa etária e outra para o número de óbitos femininos e mudar coluna da  faixa etária para os nomes adequados
mortes_femininos_idade_invertido <- as.data.frame(t(mortes_femininos_idade))%>% 
  rownames_to_column(var = "Idade")
names(mortes_femininos_idade_invertido)[2] <- "Femininos"
mortes_femininos_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Criar tabela com uma colunda para a faixa etária e outra para o número de óbitos masculinos e mudar coluna da  faixa etária para os nomes adequados
mortes_masculinos_idade_invertido <- as.data.frame(t(mortes_masculinos_idade)) %>% 
  rownames_to_column(var = "Idade")
names(mortes_masculinos_idade_invertido)[2] <- "Masculinos"
mortes_masculinos_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Criar tabela com uma colunda para a faixa etária e outra para o número de óbitos total e mudar coluna da  faixa etária para os nomes adequados
mortes_total_idade_invertido <- as.data.frame(t(mortes_total_idade)) %>% 
  rownames_to_column(var = "Idade")
names(mortes_total_idade_invertido)[2] <- "Total"
mortes_total_idade_invertido[,1] <- c("0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Juntar as 3 tabelas que criámos
mortes_fem_masc <- merge(mortes_femininos_idade_invertido, mortes_masculinos_idade_invertido, by = "Idade")
mortes_fem_masc_tot <- merge(mortes_fem_masc, mortes_total_idade_invertido, by = "Idade")

#Fazer melt para poder fazer gráfico 
mortes_fem_masc_tot_melt <- melt(mortes_fem_masc_tot, id.vars = "Idade")

#Fazer gráfico de barras com idade no eixo do x, o número de óbitos no eixo do y e o género em cada barra
ggplot(mortes_fem_masc_tot_melt, aes(x = Idade, y = value, fill = variable)) +
  geom_col(position = "dodge") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(mortes_fem_masc_tot_melt$value + 100))) +
  theme_classic() +
  labs(title = "Mortes Por Idade e Género") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("Mortes") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  guides(fill=guide_legend(title="Género")) +
  geom_text(aes(label = value), position = position_dodge(width = 0.9), vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = c("coral2", "lightblue", "saddlebrown"))
```

### Número de Mortes por Região

Por fim analisámos o número de mortes por região.

À data da análise (Setembro 2020) podemos verificar que, apesar de Lisboa e Vale do Tejo ter maior número de casos, o Norte é a região que apresenta maior número de mortes. Podemos ainda ver que a madeira não apresenta nenhuma morte por COVID19.

```{r}
#Criar tabela com uma coluna para as regiões e outra para o número mais recente total de óbitos e dar nomes
mortos_regioes <- as.data.frame(t(as.data.frame(lapply(data[,obitos_arsnorte:obitos_madeira], last)))) %>% 
  rownames_to_column(var = "Regioes")
names(mortos_regioes)[2] <- "Mortes"
mortos_regioes[, 1] <- c("Norte", "Centro", "Lisboa e Vale \ndo Tejo", "Alentejo", "Algarve", "Açores", "Madeira")

#Fazer gráfico com regiões no eixo do x e número de mortes no eixo do y
ggplot(mortos_regioes, aes(x = Regioes, y = Mortes)) +
  geom_col(fill = "salmon1") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(mortos_regioes$Mortes + 125))) +
  theme_classic() +
  labs(title = "Número de Mortes por Região") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = Mortes), vjust = -0.5, size = 4)

#mapa
##Definir intervalos da legenda
bins_3 =  c(0, 25, 50, 100, 500, 1000, Inf)

##Ordenar a tabela feita anteriormente para ficar com a mesma ordem que os poligonos do mapa
mortos_regioes_ordem <- mortos_regioes[c(4, 5, 6, 2, 7, 1, 3),]

##Definir a palete de cores
pal_3 <- colorBin("YlOrRd", domain = mortos_regioes_ordem[,2], bins = bins_3)

##Definir a legenda quando se passa com o rato por cima
labels_3 <- sprintf(
  "<strong>%s</strong><br/>%g Mortos",
  incidencia_regioes_ordem[,1], mortos_regioes_ordem[,2]
) %>% lapply(htmltools::HTML)

##Fazer o mapa
leaflet(mapa_pt) %>% 
  addTiles(group = "Normal") %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Claro") %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "Escuro") %>% 
  addLayersControl(
    baseGroups = c("Normal", "Claro", "Escuro"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal_3(mortos_regioes_ordem[,2]), 
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels_3,
    labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                             padding = "3px 8px"),
                                textsize = "15px",
                                direction = "auto")) %>% 
  addLegend(pal = pal, values = incidencia_regioes_ordem[,2]*100, opacity = 0.7, title = "Nº Mortos",
            position = "bottomright")
```

### Mortalidade

Um parâmetro importante de avaliar é a mortalidade. A mortalidade é calculada pelo número de óbitos até ao momento a dividir pela população. Desta forma calculámos a mortalidade para a população em geral, para as mulheres e para os homens.

À data desta análise (Setembro 2020) é possível ver que os homens apresentam uma taxa de mortalidade superior à das mulheres.

```{r}

#Cálculo da mortalidade total, feminina e masculina com base no valor mais recente dos óbitos, que é também o mais alto
mortalidade_total <- max(data$obitos, na.rm = TRUE) / populacao_pt
mortalidade_mulheres <- max(data$obitos_f, na.rm = TRUE) / mulheres_pt
mortalidade_homens <- max(data$obitos_m, na.rm =TRUE) / homens_pt

#Criar uma tabela com uma coluna para o género e outra para o valor da mortalidade e dar nome apropriado aos generos
mortalidade <- data.frame(t(data.frame(mortalidade_total, mortalidade_mulheres, mortalidade_homens))) %>% 
  rownames_to_column(var = "genero")
names(mortalidade)[2] <- "mortalidade"
mortalidade[, 1] <- c("Total", "Mulheres", "Homens")

#Criar um gráfico de barras com o genero no eixo do x e a mortalidade no eixo do y
ggplot(mortalidade, aes(x = genero, y = mortalidade*100)) +
  geom_col(fill = "salmon1") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(mortalidade$mortalidade*106))) +
  theme_classic() +
  labs(title = "Mortalidade", x = "") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("%") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = scales::percent(mortalidade, digits = 4)), vjust = -0.5, size = 4)
```

### Mortalidade por Região

Podemos avaliar a mortalidade também por regiões.

Lisboa e Vale do Tejo é a região que apresentava maior número de casos enquanto que o Norte era a região que apresentava maior número de mortes. No entanto, tendo em conta a população de cada região podemos concluir que as mortes em Lisboa e Vale do Tejo correspondem a uma maior porção da população do que as que ocorrem no Norte.

```{r}
#Criar tabela com uma coluna para as regiões e outra para a mortalidade mais recente e dar nomes apropriados
mortalidade_regioes <- data.frame(t(as.data.frame(lapply(data[, obitos_arsnorte:obitos_madeira], last))) 
                                  / populacao_regioes) %>% 
  rownames_to_column(var = "Regiao")
names(mortalidade_regioes)[2] <- "Mortalidade"
mortalidade_regioes[, 1] <- c("Norte", "Centro", "Lisboa e Vale \ndo Tejo", "Alentejo", "Algarve", "Açores", "Madeira")

#Fazer gráfico com regiões no eixo do x e mortaldiade no eixo do y
ggplot(mortalidade_regioes, aes(x = Regiao, y = Mortalidade*100)) +
  geom_col(fill = "gray") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(mortalidade_regioes$Mortalidade*106))) +
  theme_classic() +
  labs(title = "Mortalidade Por Região") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("Mortalidade (%)") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = scales::percent(round(Mortalidade, digits = 5))), vjust = -0.5, size = 4)

#mapa
##Definir intervalos da legenda
bins_4 =  c(0, 0.002, 0.004, 0.006, 0.008, 0.01, 0.02, Inf)

##Ordenar a tabela feita anteriormente para ficar com a mesma ordem que os poligonos do mapa
mortalidade_regioes_ordem <- mortalidade_regioes[c(4, 5, 6, 2, 7, 1, 3),]

##Definir a palete de cores
pal_4 <- colorBin("YlOrRd", domain = mortalidade_regioes_ordem[,2]*100, bins = bins_4)

##Definir a legenda quando se passa com o rato por cima
labels_4 <- sprintf(
  "<strong>%s</strong><br/>%g&#x25 Mortalidade",
  mortalidade_regioes_ordem[,1], round(mortalidade_regioes_ordem[,2]*100, digits =  3)
) %>% lapply(htmltools::HTML)

##Fazer o map
leaflet(mapa_pt) %>% 
  addTiles(group = "Normal") %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Claro") %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "Escuro") %>% 
  addLayersControl(
    baseGroups = c("Normal", "Claro", "Escuro"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal_4(mortalidade_regioes_ordem[,2]*100), 
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels_4,
    labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                             padding = "3px 8px"),
                                textsize = "15px",
                                direction = "auto")) %>% 
  addLegend(pal = pal, values = mortalidade_regioes_ordem[,2]*100, opacity = 0.7, title = "Mortalidade",
            position = "bottomright")
```

### Letalidade

Outro parâmetro importante de avaliar é a letalidade. Esta é calculada pelo número de óbitos até ao momento a dividir pelo número de confirmados até ao momento. Calculámos a letalidade total, dos homens e das mulheres.

```{r}

#Cálculo da letalidade total, feminina e masculina com base no valor mais recente dos óbitos, que é também o mais alto, e no valor mais recente de confirmados
letalidade_total <- max(data$obitos, na.rm = TRUE) / last(data$confirmados)
letalidade_mulheres <- max(data$obitos_f, na.rm = TRUE) / last(data$confirmados_f)
letalidade_homens <- max(data$obitos_m, na.rm = TRUE) / last(data$confirmados_m)

#Criar uma tabela com uma coluna para o género e outra para o valor da letalidade e dar nome apropriado aos generos
letalidade <- data.frame(t(data.frame(letalidade_total, letalidade_mulheres, letalidade_homens))) %>% 
  rownames_to_column(var = "genero")
names(letalidade)[2] <- "letalidade"
letalidade[, 1] <- c("Total", "Mulheres", "Homens")

#Criar um gráfico de barras com o genero no eixo do x e a letalidade no eixo do y
ggplot(letalidade, aes(x = genero, y = letalidade*100)) +
  geom_col(fill = "salmon1") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(letalidade$letalidade*100 + 4))) +
  theme_classic() +
  labs(title = "Letalidade", x = "") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("%") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = scales::percent(letalidade, digits = 4)), vjust = -0.5, size = 4)
```

#### Letalidade ao longo do tempo

Podemos ainda avaliar a letalidade ao longo do tempo para ver as variações que sofreu.

À data da análise destes dados (Setembro 2020), as linhas apresentam uma queda na letalidade. Para esta situação damos algumas jsutificações possíveis:

<ul>
  <li>Maiores cuidados de saúde e melhores tratamentos o que diminui os óbitos</li>
  <li>Mais diagnósticos a pessoas subclínicas ou com sintomas ligeiros o que aumenta os confirmados</li>
  <li>Mais pessoas mais jovens infetadas que têm menor probabilidade de morrer, o que mantém o aumento dos confirmados mas não permite o aumento dos óbitos</li>
  <li>Desfasamento entre o momento em que a pessoa é confirmada e o momento do óbito que pode influenciar os resultados da letalidade, a diminuição atual pode ser por pessoas confirmadas agora só morrerem daqui a uns dias</li>
  <li>Maior imunidade das pessoas o que diminui quer os confirmados quer os óbitos</li>
  <li>Menor virulência do vírus o que diminui os óbitos</li>
</ul>  

Para percebermos qual a razão mais plausível teremos de fazer outras análises, nomeadamente a letalidade ajustada à idade e ao desfasamento.

```{r}
#Calcular letalidade toal, para mulheres e para homens, criando uma tabela para cada com uma coluna para a data e outra para os valores da letalidade para cada dia
letalidade_tempo_total <- cbind(data$data, as.data.frame((data$obitos / data$confirmados)*100))
letalidade_tempo_mulheres <- cbind(data$data, as.data.frame((data$obitos_f / data$confirmados_f)*100))
letalidade_tempo_homens <- cbind(data$data, as.data.frame((data$obitos_m / data$confirmados_m)*100))

#Juntar as 3 tabelas numa só mudando os nomes de cada coluna
letalidade_tempo_total_mulheres <- merge(letalidade_tempo_total, letalidade_tempo_mulheres, by ="data$data")
letalidade_tempo <- merge(letalidade_tempo_total_mulheres, letalidade_tempo_homens, by="data$data")
names(letalidade_tempo) <- c("Data", "Total", "Mulheres", "Homens")

#Fazer o melt para poder faze um gráfico de linhas
letalidade_tempo_melt <- melt(letalidade_tempo, id.vars = "Data")
names(letalidade_tempo_melt) <- c("Data", "Genero", "Letalidade")

#Fazer gráfico de linhas com a data no eixo do x, a letalidade no eixo do y e o género em cada linha
letalidade_tempo_grafico <- ggplot(letalidade_tempo_melt, aes(x = Data, y = Letalidade, color = Genero)) +
  geom_line() +
  xlab("Mês") +
  ylab("Letalidade (%)")+
  labs(title = "Letalidade ao Longo do Tempo") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")

ggplotly(letalidade_tempo_grafico, add_tracey = "Letalidade")
```

### Letalidade por Grupo Etário e por Género

Com este gráfico, à data desta análise (Setembro 2020) é possível ver que a letalidade aumenta com o aumento da faixa etária o que quer dizer que quando as pessoas são infetadas, quanto maior for a sua idade, maior a probabilidade de morrerem.

É ainda possível ver que a letalidde é maior para o sexo masculino do que para o sexo feminino.

```{r}
#Tabela com número de casos confirmados por faixa etária por género
casos_genero <- merge(casos_femininos_idade_invertido, casos_masculinos_idade_invertido, by = "Idade")
casos_genero_total <-  merge(casos_genero, casos_total_idade_invertido, by = "Idade")

#Tabela com número de óbitos por faixa etária por género
mortes_genero <- merge(mortes_femininos_idade_invertido, mortes_masculinos_idade_invertido, by = "Idade")
mortes_genero_total <-  merge(mortes_genero, mortes_total_idade_invertido, by = "Idade")

#Criar tabela com uma coluna com as faixas etárioas e outra com a letalidade e dar nomes às colunas
letalidade_genero <- cbind(casos_femininos_idade_invertido[,1], (mortes_genero_total[,2:4]/casos_genero_total[,2:4]))
names(letalidade_genero) <- c("Idade", "Feminino", "Masculino", "Total")

#Fazer melt para poder fazer gráfico
letalidade_genero_melt <- melt(letalidade_genero, id.vars = "Idade")

#Fazer gráfico com idade no eixo do x, letalidade no eixo do y e faixa etária em cada linha
letalidade_genero_grafico <- ggplot(letalidade_genero_melt, aes(x = Idade, y = value*100, color = variable, 
                                                              tooltip = round(value*100, digits = 2), data_id = value)) +
  geom_point_interactive() +
  guides(color = FALSE) +
  facet_grid(letalidade_genero_melt$variable) +
  xlab("Faixa Etária (anos)") +
  ylab("Letalidade (%)") +
  labs(title = "Letalidade por Faixa Etária por Género") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15))

#Interatividade do gráfico 
girafe(code = print(letalidade_genero_grafico),
       options = list(
         opts_zoom(max = 5),
          opts_hover(css = "fill:black;")
))
 
```

### Letalidade por Grupo Etário ao Longo do Tempo

```{r}
#Tabela com o número de mortes total diários por faixa etária
total_mortes_novos <- femininos_mortes + masculinos_mortes
  
#Tabela com o número de casos totais diários por faixa etária
total_casos_novos <- femininos + masculinos

#Tabela com uma coluna com a data e outras com cada faixa etária onde tem o valor da letalidade total para cada dia e  dar nomes às colunas
letalidade_tempo_idade <- cbind(data$data, total_mortes_novos/total_casos_novos)
names(letalidade_tempo_idade) <- c("Data", "0-9", "10-19", "20-29", "30-39", "40-49", "50-59", "60-69", "70-79", "80+")

#Fazer melt para fazer o gráfico
letalidade_tempo_idade_melt <- melt(letalidade_tempo_idade, id.vars = "Data")

#Fazer o gráfico
ggplot(letalidade_tempo_idade_melt, aes(x = Data, y = value*100, color = variable)) +
  geom_line() +
  facet_grid(letalidade_tempo_idade_melt$variable) +
  guides(color = FALSE) +
  xlab("Mês") +
  ylab("Letalidade (%)") +
  labs(title = "Letalidade por Faixa Etária ao Longo do Tempo") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

### Letalidade por Região

```{r}
#Fazer uma tabela com uma coluna com a região e outra com a letalidade para cada região e dar nomes adequados
letalidade_regioes <- data.frame(t(as.data.frame(lapply(data[, obitos_arsnorte:obitos_madeira], last)) 
                                   / (as.data.frame(lapply(data[, confirmados_arsnorte:confirmados_madeira], last))))) %>% 
  rownames_to_column(var = "Regiao")
names(letalidade_regioes)[2] <- "Letalidade"
letalidade_regioes[, 1] <- c("Norte", "Centro", "Lisboa e Vale \ndo Tejo", "Alentejo", "Algarve", "Açores", "Madeira")

#Fazer o gráfico com a região no eixo do x e a letalidade no eixo do y
ggplot(letalidade_regioes, aes(x = Regiao, y = Letalidade*100)) +
  geom_col(fill = "gray") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian( ylim = c(0, max(letalidade_regioes$Letalidade*106))) +
  theme_classic() +
  labs(title = "Letalidade Por Região") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "Black", hjust = 0.5)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  theme(axis.text.x = element_text(size=12, color = "black")) +
  ylab("Letalidade (%)") +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.text.y = element_text(size=12, color = "black")) +
  geom_text(aes(label = scales::percent(round(Letalidade, digits = 5))), vjust = -0.5, size = 4)

#mapa
##Definir intervalos da legenda
bins_5 =  c(0, 1, 2, 3, 4, 5, 6, 7, Inf)

##Ordenar a tabela feita anteriormente para ficar com a mesma ordem que os poligonos do mapa
letalidade_regioes_ordem <- letalidade_regioes[c(4, 5, 6, 2, 7, 1, 3),]

##Definir a palete de cores
pal_5 <- colorBin("YlOrRd", domain = letalidade_regioes_ordem[,2]*100, bins = bins_5)

##Definir a legenda quando se passa com o rato por cima
labels_5 <- sprintf(
  "<strong>%s</strong><br/>%g&#x25 Letalidade",
  letalidade_regioes_ordem[,1], round(letalidade_regioes_ordem[,2]*100, digits =  2)
) %>% lapply(htmltools::HTML)

##Fazer o map
leaflet(mapa_pt) %>% 
  addTiles(group = "Normal") %>% 
  addProviderTiles(providers$CartoDB.Positron, group = "Claro") %>% 
  addProviderTiles(providers$CartoDB.DarkMatterNoLabels, group = "Escuro") %>% 
  addLayersControl(
    baseGroups = c("Normal", "Claro", "Escuro"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>% 
  addPolygons(
    fillColor = ~pal_5(letalidade_regioes_ordem[,2]*100), 
    weight = 2,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels_5,
    labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                             padding = "3px 8px"),
                                textsize = "15px",
                                direction = "auto")) %>% 
  addLegend(pal = pal, values = letalidade_regioes_ordem[,2]*100, opacity = 0.7, title = "Letalidade",
            position = "bottomright")
```

### Letalidade por Região ao Longo do Tempo

```{r}
###Criar tabela com uma coluna para data e outras colunas uma para cada região tendo lá os valores da letalidade diária
###e dar nomes às colunas
letalidade_regioes_tempo <- cbind(data$data, as.data.frame(data[,49:55]/data[,4:10]))
names(letalidade_regioes_tempo) <- c("Data", "Norte", "Centro", "Lisboa e Vale do Tejo", "Alentejo", 
                                     "Alrgarve", "Açores", "Madeira")

###Fazer melt para poder fazer o gráfico
letalidade_regioes_tempo_melt <- melt(letalidade_regioes_tempo, id.vars = "Data")

###Fazer o gráfico de linhas com data no eixo do x, letalidade no eixo do y e regiao em cada linha
ggplot(letalidade_regioes_tempo_melt, aes(x = Data, y = value*100, color = variable)) +
  geom_line() +
  guides(color = FALSE) +
  xlab("Mês") +
  ylab("Letalidade (%)") +
  labs(title = "Letalidade por Regiões ao Longo do Tempo") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

# Recuperados

Com a análise atual (Setembro 2020) deste gráfico é possível ver que entre Maio e Junho houve um grande aumento do número de recuperados, possivelmente por:

<ul>
  <li>Falta de registo do número de recuperados anteriormente o que faz com que o número de recuperados seja inferior ao real até aos meses de Maio/Junho e que possivelmete seja superior ao real nos meses seguintes por se ter introduzido esses recuperados mais tarde</li>
  <li>Infeção de população mais jovem que recupera mais facilmente o que aumenta o número de recuperados </li>
  <li>Mais cuidados médicos e melhores tratamentos o que aumenta os recuperados</li>
  <li>Menos virulência do vírus</li>
</ul>

Atualmente verifica-se uma diminuição na percentagem de recuperados. Isto pode dever-se a:

<ul>
  <li>Falta de registo do número de recuperados o que faz com que o número de recuperados seja inferior ao real</li>
  <li>Os recuperados que faltavam registar acabaram agora de ser registados então a curva está a diminuir porque se registam menos recuperados por dia mas agora é mais aproxiamda do real</li>
  <li>Mais casos de infeção confirmados e que naturalmente demora até que sejam dados como recuperados</li>
  <li>Infeções mais graves com mais dificuldade na recuperação</li>
  <li>Infeção de população mais velha que recupera menos</li>
  <li>Maior virulência do vírus</li>
</ul>

```{r}
#Criar tabela com coluna para data e outra coluna para a percentagem de recuperados em cada dia e dar nomes Às colunas
recuperados <- cbind(data$data, as.data.frame(data$recuperados / data$confirmados))
names(recuperados) <- c("Data", "Recuperados")

#Fazer gráfico de linhas com data no eixo do x e percentagem recuperados no eixo y
ggplot(recuperados, aes(x = Data, y = Recuperados*100)) +
  geom_line(color = "salmon1", size = 1) +
  labs(title = "Percentagem de Recuperados dentro dos Infetados", y = "Recuperados (%)", x = "Mês") +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

# Internados
## Número de Internados ao Longo do Tempo

```{r}
#Fazer melt das colunas data, internados e internados UCI para ter número de internados em cada dia
internados <- melt(data[,c(1, 15, 16)], id.vars = "data")

#Fazer gráfico de linhas com data no eixo do x, número de internados no eixo do y e tipo de internamento nas linhas
ggplot(internados, aes(x = data, y =value, color = variable)) +
  geom_line(size = 1) +
  labs(title = "Número de Internados ao Longo do Tempo", y = "Número Pessoas", x = "Mês", color = "") +
  scale_color_discrete(labels = c("Internados", "Internados UCI")) +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

## Percentagem de Internados ao Longo do Tempo

```{r}
#Fazer melt para ter tabela com coluna da data, coluna do tipo de internamento e coluna com percentagem de internados que são os internados a dividir pelos confirmados e dar nomes às colunas
internados_confirmados <- melt((cbind(data$data, (as.data.frame(lapply(data[,c(15, 16)], 
                                                  function(x) {x/data[, 3]}))))), id.vars = "data$data")
names(internados_confirmados) <- c("data", "internados", "percentagem")

#Fazer gráfico de linhas com data no eixo do x, percentagem internados no eixo do y e tipo de internamento em cada linha
ggplot(internados_confirmados, aes(x = data, y =percentagem*100, color = internados)) +
  geom_line(size = 1) +
  labs(title = "Percentagem Internados dentro dos Infetados ao Longo do Tempo", y = "Percentagem (%)",
       x = "Mês", color = "") +
  scale_color_discrete(labels = c("Internados", "Internados UCI")) +
  theme(plot.title = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), 
                                  size = 20, color = "black", hjust = 0.5)) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 20), size = 15)) +
  theme(axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 20, l = 0), size = 15)) +
  scale_x_date(breaks = "months", date_labels = "%B")
```

